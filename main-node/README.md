# ğŸ§  Main Node â€” Data Fetcher & Monitoring Server

This repository contains the **data ingestion and monitoring backend** for a distributed LED dashboard system.  
It runs on a **Raspberry Pi or local server**, periodically **fetches data** from a remote API (defined by an OpenAPI specification), stores it in a **local SQLite database**, and exposes a **FastAPI web dashboard** and **email alerts**.

## ğŸ—ï¸ System Overview

### Responsibilities
- Periodically fetch data from a REST API using an autogenerated OpenAPI client
- Normalize, validate, and store the data locally (SQLite in WAL mode)
- Expose a web dashboard (FastAPI + HTMX) for monitoring
- Provide metrics and JSON endpoints for other devices on the LAN
- Send alert emails if data fetching fails or stalls
- Serve a lightweight `/snapshot` endpoint for display nodes

### Interaction Diagram
```text
+----------------------+
|   Remote API Source  |
+----------+-----------+
           |
           v
+----------------------+
|     Main Node        |
|  (Fetcher + Monitor) |
+----------+-----------+
           |
       LAN / WiFi
           |
           v
+----------------------+
|   Display Node(s)    |
+----------------------+
```
---

## âš™ï¸ Technology Stack

| Layer         | Library / Framework                                                                    |
| ------------- | -------------------------------------------------------------------------------------- |
| Language      | Python 3.11+                                                                           |
| API Client    | [`openapi-python-client`](https://github.com/openapi-generators/openapi-python-client) |
| HTTP Client   | `httpx` (async)                                                                        |
| Scheduler     | `APScheduler`                                                                          |
| Database      | `SQLite` + `SQLAlchemy 2.x`                                                            |
| Web Framework | `FastAPI`                                                                              |
| Frontend      | `HTMX` + `Tailwind CSS`                                                                |
| Email         | `aiosmtplib`                                                                           |
| Logging       | `structlog`                                                                            |
| Deployment    | `systemd` service or Docker                                                            |

---

## ğŸ“ Folder Structure

```text
main-node/
â”‚
â”œâ”€ src/
â”‚   â”œâ”€ api/
â”‚   â”‚   â”œâ”€ client.py          # Generated OpenAPI client
â”‚   â”‚   â””â”€ fetcher.py         # Fetching + transformation logic
â”‚   â”‚
â”‚   â”œâ”€ db/
â”‚   â”‚   â”œâ”€ models.py          # SQLAlchemy ORM definitions
â”‚   â”‚   â”œâ”€ repository.py      # CRUD utilities
â”‚   â”‚   â””â”€ session.py         # Session setup + WAL mode
â”‚   â”‚
â”‚   â”œâ”€ monitor/
â”‚   â”‚   â”œâ”€ web.py             # FastAPI app entrypoint
â”‚   â”‚   â”œâ”€ templates/         # HTMX + Jinja2 templates
â”‚   â”‚   â”œâ”€ static/            # Tailwind CSS assets
â”‚   â”‚   â””â”€ alerts.py          # Email alerts + notifications
â”‚   â”‚
â”‚   â”œâ”€ scheduler.py           # APScheduler jobs for fetching + alerts
â”‚   â”œâ”€ config.py              # Pydantic-based configuration
â”‚   â””â”€ main.py                # Unified entrypoint (CLI or service)
â”‚
â”œâ”€ requirements.txt
â””â”€ README.md
```

## ğŸ”Œ API Endpoints

| Endpoint    | Description                                        |
| ----------- | -------------------------------------------------- |
| `/status`   | Returns system status (last fetch, errors, counts) |
| `/metrics`  | Prometheus-compatible metrics                      |
| `/snapshot` | Returns latest dataset for display nodes           |
| `/web`      | Interactive HTMX monitoring UI                     |

---

## ğŸ“§ Email Alerts

- Sends notification if:
  - No successful fetch for more than **X minutes**
  - Consecutive fetch failures exceed threshold
- SMTP credentials configured via `.env` or environment variables.

Example:
```bash
SMTP_HOST=smtp.gmail.com
SMTP_USER=example@gmail.com
SMTP_PASS=app-password
ALERT_EMAIL=admin@example.com
```

## ğŸ§  Shared Data Schema

All systems (including display nodes) share the same schema:
```sql
CREATE TABLE records (
    id INTEGER PRIMARY KEY,
    timestamp TEXT NOT NULL,
    key TEXT NOT NULL,
    value REAL,
    meta JSON
);
```

Data format for /snapshot:
```json
{
  "timestamp": "2025-10-30T20:00:00Z",
  "records": [
    {"key": "temperature", "value": 21.4},
    {"key": "humidity", "value": 45.2}
  ],
  "summary": {"count": 2, "avg": 33.3}
}
```

## Integration with Display Nodes
- Display nodes query /snapshot every few seconds for updates.
- Both use the same SQLite schema for local fallback.
- Communication is over LAN (default: http://main-node.local:8000).


## ğŸš€ Getting Started

1. Install Dependencies
    ```bash
    sudo apt install python3-venv
    python3 -m venv venv
    source venv/bin/activate
    pip install -r requirements.txt
    ```
2. Generate API Client
    ```bash
    openapi-python-client generate --path openapi.yaml
    ```
3. Run Server
    ```bash
    python -m src.main --mode=server
    ```
Then open your browser at:
ğŸ‘‰ http://<raspberrypi>:8000/web

## ğŸ§© Code Style & GitHub Copilot Tips
- Use type hints everywhere â€” Copilot will infer context better.
- Each module should start with a docstring summarizing its role.
- Prefer async functions for IO-bound operations.
- Keep fetch and render logic isolated for reusability.
    
## ğŸ§  Future Extensions
- Add MQTT or WebSocket streaming
- Integrate Grafana via /metrics
- Add multiple API sources and merging logic

